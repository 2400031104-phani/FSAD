<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thank You â€” DonateHub</title>
    <link rel="stylesheet" href="css/styles.css" />
    <style>
        /* â”€â”€ Confirmation page layout â”€â”€ */
        .confirm-wrapper {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--sp-8) var(--sp-4);
        }

        /* â”€â”€ Hero thank-you card â”€â”€ */
        .thanks-card {
            width: 100%;
            max-width: 540px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            padding: 2.75rem 2.5rem;
            text-align: center;
            animation: cardEntrance 0.55s cubic-bezier(0.34,1.56,0.64,1) both;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        @keyframes cardEntrance {
            from { opacity: 0; transform: translateY(32px) scale(0.95); }
            to   { opacity: 1; transform: translateY(0)   scale(1);    }
        }

        /* â”€â”€ Pulse icon â”€â”€ */
        .thanks-icon-wrap {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 88px;
            height: 88px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(108,99,255,0.25), rgba(255,107,157,0.20));
            border: 2px solid rgba(108,99,255,0.45);
            font-size: 2.5rem;
            margin-bottom: var(--sp-5);
            animation: pulse 2.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0   rgba(108,99,255,0.45); }
            50%       { box-shadow: 0 0 0 14px rgba(108,99,255,0);    }
        }

        /* â”€â”€ Primary heading â”€â”€ */
        .thanks-heading {
            font-family: var(--font-heading);
            font-size: clamp(1.75rem, 5vw, 2.5rem);
            font-weight: 800;
            line-height: 1.15;
            margin-bottom: var(--sp-3);
            background: var(--grad-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .thanks-sub {
            font-size: var(--fs-base);
            color: var(--clr-text-2);
            margin-bottom: var(--sp-8);
            line-height: 1.65;
        }

        /* â”€â”€ Divider â”€â”€ */
        .thanks-divider {
            height: 1px;
            background: var(--clr-border);
            margin: var(--sp-6) 0;
        }

        /* â”€â”€ Detail grid â”€â”€ */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--sp-3);
            margin-bottom: var(--sp-6);
            text-align: left;
        }

        .detail-cell {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--clr-border);
            border-radius: var(--radius-md);
            padding: var(--sp-3) var(--sp-4);
        }

        .detail-cell-label {
            font-size: var(--fs-xs);
            color: var(--clr-text-3);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: var(--sp-1);
        }

        .detail-cell-value {
            font-size: var(--fs-base);
            font-weight: 700;
            color: var(--clr-text);
            word-break: break-word;
        }

        /* badge accent per type */
        .detail-cell-value.food-val  { color: var(--clr-primary-l); }
        .detail-cell-value.apparel-val { color: var(--clr-accent-2); }
        .detail-cell-value.money-val  { color: var(--clr-accent); }

        /* â”€â”€ Action buttons â”€â”€ */
        .action-row {
            display: flex;
            flex-direction: column;
            gap: var(--sp-3);
        }

        @media (min-width: 420px) {
            .action-row { flex-direction: row; }
            .action-row .btn { flex: 1; }
        }

        /* â”€â”€ Confetti particles â”€â”€ */
        .confetti-field {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .confetti-piece {
            position: absolute;
            top: -16px;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            opacity: 0;
            animation: confettiFall linear forwards;
        }

        @keyframes confettiFall {
            0%   { opacity: 1; transform: translateY(0)    rotate(0deg);   }
            80%  { opacity: 1; }
            100% { opacity: 0; transform: translateY(110vh) rotate(720deg); }
        }

        /* â”€â”€ Type banner â”€â”€ */
        .type-banner {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-2);
            background: rgba(108,99,255,0.15);
            border: 1px solid rgba(108,99,255,0.30);
            border-radius: var(--radius-full);
            padding: var(--sp-1) var(--sp-4);
            font-size: var(--fs-xs);
            font-weight: 700;
            color: var(--clr-primary-l);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            margin-bottom: var(--sp-5);
        }

        .ref-code {
            font-family: 'Courier New', monospace;
            font-size: var(--fs-xs);
            color: var(--clr-text-3);
            margin-top: var(--sp-5);
        }

        /* â”€â”€ COMMIT verified badge â”€â”€ */
        .commit-badge {
            display: none;   /* shown by JS when dms_thanks flag is present */
            align-items: center;
            justify-content: center;
            gap: var(--sp-2);
            margin-top: var(--sp-5);
            padding: var(--sp-2) var(--sp-4);
            border-radius: var(--radius-full);
            background: rgba(0, 212, 100, 0.12);
            border: 1px solid rgba(0, 212, 100, 0.30);
            font-size: var(--fs-xs);
            font-weight: 700;
            color: #00d464;
            letter-spacing: 0.05em;
        }

        .commit-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: #00d464;
            animation: commitPulse 1.8s ease-in-out infinite;
            flex-shrink: 0;
        }

        @keyframes commitPulse {
            0%, 100% { opacity: 1; transform: scale(1);    }
            50%       { opacity: 0.4; transform: scale(0.7); }
        }

        /* â”€â”€ Status badge â”€â”€ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--sp-2);
            border-radius: var(--radius-full);
            padding: var(--sp-1) var(--sp-4);
            font-size: var(--fs-xs);
            font-weight: 700;
            letter-spacing: 0.06em;
            margin-bottom: var(--sp-5);
        }
        .status-badge.status-pending  { background: rgba(255,165,0,0.15);   border: 1px solid rgba(255,165,0,0.40);   color: #ffa500; }
        .status-badge.status-approved { background: rgba(0,212,100,0.15);   border: 1px solid rgba(0,212,100,0.40);   color: #00d464; }
        .status-badge.status-rejected { background: rgba(255,107,157,0.15); border: 1px solid rgba(255,107,157,0.40); color: #ff6b9d; }

        .status-dot {
            width: 6px; height: 6px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-badge.status-pending  .status-dot { background: #ffa500; animation: statusPulse 1.5s ease-in-out infinite; }
        .status-badge.status-approved .status-dot { background: #00d464; }
        .status-badge.status-rejected .status-dot { background: #ff6b9d; }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0   rgba(255,165,0,0.5); }
            50%       { opacity: 0.7; box-shadow: 0 0 0 5px rgba(255,165,0,0); }
        }

        /* â”€â”€ Icon wrap colour per status â”€â”€ */
        .thanks-icon-wrap.status-pending {
            background: linear-gradient(135deg, rgba(255,165,0,0.20), rgba(245,158,11,0.15));
            border-color: rgba(255,165,0,0.50);
            animation-name: pulseAmber;
        }
        .thanks-icon-wrap.status-approved {
            background: linear-gradient(135deg, rgba(0,212,100,0.22), rgba(0,180,80,0.15));
            border-color: rgba(0,212,100,0.50);
            animation-name: pulseGreen;
        }
        .thanks-icon-wrap.status-rejected {
            background: linear-gradient(135deg, rgba(255,107,157,0.22), rgba(220,50,90,0.15));
            border-color: rgba(255,107,157,0.50);
            animation: none;
        }

        @keyframes pulseAmber {
            0%, 100% { box-shadow: 0 0 0 0   rgba(255,165,0,0.4); }
            50%       { box-shadow: 0 0 0 14px rgba(255,165,0,0); }
        }
        @keyframes pulseGreen {
            0%, 100% { box-shadow: 0 0 0 0   rgba(0,212,100,0.4); }
            50%       { box-shadow: 0 0 0 14px rgba(0,212,100,0); }
        }

        /* â”€â”€ Heading colour per status â”€â”€ */
        .thanks-heading.status-pending {
            background: linear-gradient(135deg, #ffa500, #f59e0b);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .thanks-heading.status-approved {
            background: linear-gradient(135deg, #00d464, #00b854);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        .thanks-heading.status-rejected {
            background: linear-gradient(135deg, #ff6b9d, #e0346c);
            -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* â”€â”€ Rejection reason box â”€â”€ */
        .rejection-box {
            background: rgba(255,107,157,0.08);
            border: 1px solid rgba(255,107,157,0.30);
            border-radius: var(--radius-md);
            padding: var(--sp-4) var(--sp-5);
            margin-bottom: var(--sp-6);
            text-align: left;
        }
        .rejection-box-label {
            font-size: var(--fs-xs);
            font-weight: 700;
            color: var(--clr-text-3);
            text-transform: uppercase;
            letter-spacing: 0.06em;
            margin-bottom: var(--sp-2);
        }
        .rejection-box-text {
            font-size: var(--fs-sm);
            color: #ff6b9d;
            line-height: 1.65;
            word-break: break-word;
        }
    </style>
</head>

<body class="page-wrapper" style="align-items:center; justify-content:center;">
    <div class="bg-orb bg-orb-1"></div>
    <div class="bg-orb bg-orb-2"></div>
    <div class="bg-orb bg-orb-3"></div>

    <!-- Confetti canvas -->
    <div class="confetti-field" id="confettiField" aria-hidden="true"></div>

    <div class="confirm-wrapper" style="position:relative; z-index:1;">

        <!-- â”€â”€ Header (minimal) â”€â”€ -->
        <a href="dashboard.html"
           style="display:inline-flex; align-items:center; gap:var(--sp-2); margin-bottom:var(--sp-8); color:var(--clr-text-2); font-size:var(--fs-sm); font-weight:600; transition:color var(--t-fast);"
           onmouseover="this.style.color='var(--clr-text)'"
           onmouseout="this.style.color='var(--clr-text-2)'">
            <div class="brand-icon" style="font-size:1.25rem; line-height:1;">ğŸ’</div>
            <span class="text-gradient" style="font-family:var(--font-heading); font-size:1rem;">DonateHub</span>
        </a>

        <!-- â”€â”€ Main card â”€â”€ -->
        <div class="thanks-card">

            <!-- Animated icon (updated per type by JS) -->
            <div class="thanks-icon-wrap" id="thanksIcon">ğŸ‰</div>

            <!-- Live status badge (set by JS) -->
            <div class="status-badge status-pending" id="statusBadge">
                <span class="status-dot"></span>
                <span id="statusBadgeText">Pending Review</span>
            </div>

            <!-- Type banner -->
            <div class="type-banner" id="typeBanner">Donation</div>

            <!-- Headline -->
            <h1 class="thanks-heading" id="thanksHeading">Thanks for donating!</h1>

            <p class="thanks-sub" id="thanksSub">
                Your generosity makes a real difference. Every contribution
                helps build a better tomorrow.
            </p>

            <!-- Rejection reason (shown only when status = rejected) -->
            <div class="rejection-box" id="rejectionBox" style="display:none;">
                <div class="rejection-box-label">Reason for Rejection</div>
                <div class="rejection-box-text" id="rejectionText"></div>
            </div>

            <!-- Detail grid (populated by JS) -->
            <div class="detail-grid" id="detailGrid">
                <!-- JS inserts cells here -->
            </div>

            <div class="thanks-divider"></div>

            <!-- Action buttons -->
            <div class="action-row">
                <a id="donateAgainBtn" href="dashboard.html" class="btn btn-primary">
                    Donate Again ğŸ’
                </a>
                <a href="dashboard.html" class="btn btn-ghost">
                    â† Dashboard
                </a>
            </div>

            <!-- Record reference -->
            <p class="ref-code" id="refCode"></p>

            <!-- COMMIT verified badge (shown only when dms_thanks flag is set) -->
            <div class="commit-badge" id="commitBadge">
                <span class="commit-dot"></span>
                Master Table + Sub-Table COMMIT verified
            </div>
        </div>

    </div>

    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/service.js"></script>
    <script>
        const session = requireAuth();
        if (!session) throw new Error('Unauthenticated');

        /* â”€â”€ Age label map (mirrors apparel.html) â”€â”€ */
        const AGE_LABELS = {
            10: 'Children (â‰¤10)',
            19: 'Teens (11â€“19)',
            20: 'Young Adults (20s)',
            30: 'Adults (30s)',
            45: 'Middle Age (45+)'
        };

        /* â”€â”€ Type metadata â”€â”€ */
        const TYPE_META = {
            food:    { icon: 'ğŸŒ¾', label: 'Food Inventory',     accent: 'food-val',    backHref: 'food-inventory.html' },
            apparel: { icon: 'ğŸ‘•', label: 'Apparel Donation',   accent: 'apparel-val', backHref: 'apparel.html'        },
            money:   { icon: 'ğŸ’³', label: 'Financial Donation', accent: 'money-val',   backHref: 'money.html'          }
        };

        /* â”€â”€ Consume the one-time dms_thanks COMMIT flag â”€â”€â”€â”€â”€â”€â”€â”€
           Written by service.js after _verifyCommit passes.
           Removed immediately so it is not re-consumed on refresh. */
        const thanksFlag = (function () {
            try {
                const raw = sessionStorage.getItem('dms_thanks');
                sessionStorage.removeItem('dms_thanks');
                return raw ? JSON.parse(raw) : null;
            } catch (e) { return null; }
        })();

        /* â”€â”€ Read record ID from URL â”€â”€ */
        const params = new URLSearchParams(window.location.search);
        const rid    = params.get('rid');
        const record = rid ? DonationService.getRecordById(rid) : null;

        /* â”€â”€ Ownership guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           Reject any attempt to view a record that belongs to
           a different user. Admin sessions are exempt so they
           can deep-link to any confirmation directly.           */
        if (record && record.userId !== session.userId && session.role !== 'admin') {
            window.location.replace('403.html');
            throw new Error('Access denied: record does not belong to this user');
        }

        /* â”€â”€ Populate card â”€â”€ */
        (function populateCard() {
            if (!record) {
                qs('#detailGrid').innerHTML = '';
                qs('#refCode').textContent  = '';
                return;
            }

            const meta = TYPE_META[record.type] || TYPE_META.food;

            /* Derive status â€” new records carry donation_status;
               old records (pre-migration) fall back to the approved boolean. */
            const status = record.donation_status ||
                (record.approved === true  ? 'approved' :
                 record.approved === false ? 'rejected' : 'pending');

            /* Config table: one entry per status */
            var STATUS_CFG = {
                pending: {
                    icon:      meta.icon,
                    badge:     'Pending Review',
                    heading:   'Under Review',
                    sub:       'Your donation has been received and is awaiting admin review. ' +
                               'You\'ll be notified here once a decision is made.',
                    cls:       'status-pending'
                },
                approved: {
                    icon:      'âœ…',
                    badge:     'Donation Accepted',
                    heading:   'Donation Accepted!',
                    sub:       'Your donation has been approved! Thank you â€” your generosity ' +
                               'makes a real difference.',
                    cls:       'status-approved'
                },
                rejected: {
                    icon:      'âŒ',
                    badge:     'Donation Rejected',
                    heading:   'Donation Rejected',
                    sub:       'Unfortunately your donation was not accepted by the admin. ' +
                               'See the reason below and feel free to re-submit.',
                    cls:       'status-rejected'
                }
            };

            var cfg = STATUS_CFG[status] || STATUS_CFG.pending;

            /* â”€â”€ Apply status theme â”€â”€ */
            var iconEl    = qs('#thanksIcon');
            var badgeEl   = qs('#statusBadge');
            var headingEl = qs('#thanksHeading');

            iconEl.textContent = cfg.icon;
            iconEl.className   = 'thanks-icon-wrap ' + cfg.cls;

            badgeEl.className  = 'status-badge ' + cfg.cls;
            qs('#statusBadgeText').textContent = cfg.badge;

            headingEl.className   = 'thanks-heading ' + cfg.cls;
            headingEl.textContent = cfg.heading;
            qs('#thanksSub').textContent = cfg.sub;

            /* â”€â”€ Rejection reason â”€â”€ */
            if (status === 'rejected' && record.rejectionReason) {
                qs('#rejectionBox').style.display = 'block';
                qs('#rejectionText').textContent  = record.rejectionReason;
            }

            /* â”€â”€ Type banner â”€â”€ */
            qs('#typeBanner').textContent = meta.label;

            /* â”€â”€ "Donate Again" destination â”€â”€ */
            qs('#donateAgainBtn').href = meta.backHref;

            /* â”€â”€ Detail grid â”€â”€ */
            qs('#detailGrid').innerHTML = buildDetailCells(record, meta.accent, status);

            /* â”€â”€ Ref code â”€â”€ */
            const d = new Date(record.createdAt);
            qs('#refCode').textContent =
                'Record ID: ' + record.id + '  Â·  ' + d.toLocaleString();

            /* â”€â”€ COMMIT badge â”€â”€ */
            if (thanksFlag && thanksFlag.committed && thanksFlag.donationId === record.id) {
                qs('#commitBadge').style.display = 'flex';
            }
        })();

        /* â”€â”€ Build detail cells by joining sub-tables â”€â”€ */
        function buildDetailCells(r, accentClass, status) {
            var statusColor = status === 'approved' ? '#00d464'
                            : status === 'rejected' ? '#ff6b9d' : '#ffa500';
            var statusLabel = status === 'approved' ? 'âœ… Approved'
                            : status === 'rejected' ? 'âœ• Rejected' : 'â³ Pending Review';

            const shared =
                '<div class="detail-cell">' +
                  '<div class="detail-cell-label">Type</div>' +
                  '<div class="detail-cell-value ' + accentClass + '">' +
                    ((TYPE_META[r.type] || {}).label || r.type) +
                  '</div>' +
                '</div>' +
                '<div class="detail-cell">' +
                  '<div class="detail-cell-label">Donor</div>' +
                  '<div class="detail-cell-value">' + session.fullName + '</div>' +
                '</div>' +
                '<div class="detail-cell" style="grid-column:1/-1;">' +
                  '<div class="detail-cell-label">Donation Status</div>' +
                  '<div class="detail-cell-value" style="color:' + statusColor + ';">' +
                    statusLabel +
                  '</div>' +
                '</div>';

            if (r.type === 'food') {
                const sub = DonationService.getFoodByDonationId(r.id) || {};
                return shared +
                    '<div class="detail-cell">' +
                      '<div class="detail-cell-label">ğŸš Rice</div>' +
                      '<div class="detail-cell-value ' + accentClass + '">' +
                        (sub.rice_qty != null ? sub.rice_qty : 'â€”') + ' kg' +
                      '</div>' +
                    '</div>' +
                    '<div class="detail-cell">' +
                      '<div class="detail-cell-label">ğŸ¥¦ Vegetables</div>' +
                      '<div class="detail-cell-value ' + accentClass + '">' +
                        (sub.veg_qty != null ? sub.veg_qty : 'â€”') + ' kg' +
                      '</div>' +
                    '</div>';
            }

            if (r.type === 'apparel') {
                const sub = DonationService.getClothesByDonationId(r.id) || {};
                const age = sub.target_age;
                return shared +
                    '<div class="detail-cell" style="grid-column:1/-1;">' +
                      '<div class="detail-cell-label">ğŸ‘• Age Group</div>' +
                      '<div class="detail-cell-value ' + accentClass + '">' +
                        (age != null ? age + ' â€” ' + (AGE_LABELS[age] || '') : 'â€”') +
                      '</div>' +
                    '</div>';
            }

            if (r.type === 'money') {
                const sub = DonationService.getMoneyByDonationId(r.id) || {};
                const payload = sub.qr_payload || '';
                const shortPayload = payload.length > 40
                    ? payload.slice(0, 40) + 'â€¦'
                    : (payload || 'â€”');
                return shared +
                    '<div class="detail-cell">' +
                      '<div class="detail-cell-label">Transaction Ref</div>' +
                      '<div class="detail-cell-value ' + accentClass + '" style="font-size:var(--fs-sm);">' +
                        (sub.transaction_id || 'â€”') +
                      '</div>' +
                    '</div>' +
                    '<div class="detail-cell">' +
                      '<div class="detail-cell-label">QR Payload</div>' +
                      '<div class="detail-cell-value" style="font-size:var(--fs-xs); font-family:monospace; color:var(--clr-text-2);">' +
                        shortPayload +
                      '</div>' +
                    '</div>';
            }

            return shared;
        }

        /* â”€â”€ Confetti burst â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        (function launchConfetti() {
            /* Celebrate on fresh submit (pending) and on approval; skip for rejected */
            var st = record
                ? (record.donation_status ||
                   (record.approved === true  ? 'approved' :
                    record.approved === false ? 'rejected' : 'pending'))
                : 'pending';
            if (st === 'rejected') return;
            const COLORS = [
                '#6c63ff', '#a855f7', '#ff6b9d', '#00d4aa',
                '#ffa94d', '#fbbf24', '#60a5fa', '#f472b6'
            ];
            const field = qs('#confettiField');
            const count = 72;

            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-piece';

                const isCircle = Math.random() > 0.55;
                el.style.cssText = [
                    'left: '             + Math.random() * 100 + '%',
                    'width: '            + (6 + Math.random() * 8) + 'px',
                    'height: '           + (6 + Math.random() * 8) + 'px',
                    'border-radius: '    + (isCircle ? '50%' : '2px'),
                    'background: '       + COLORS[Math.floor(Math.random() * COLORS.length)],
                    'animation-duration: ' + (1.6 + Math.random() * 2) + 's',
                    'animation-delay: ' + (Math.random() * 0.8) + 's'
                ].join('; ');

                field.appendChild(el);
            }

            setTimeout(function () { field.innerHTML = ''; }, 4000);
        })();
    </script>
</body>

</html>
